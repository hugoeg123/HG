<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corre√ß√£o do Problema de Login</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .step { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>üîß Corre√ß√£o do Problema de Login</h1>
    
    <div class="step info">
        <h3>Diagn√≥stico Autom√°tico</h3>
        <div id="diagnosis">Executando diagn√≥stico...</div>
    </div>
    
    <div class="step">
        <h3>A√ß√µes de Corre√ß√£o</h3>
        <button onclick="clearStorage()">Limpar localStorage</button>
        <button onclick="testLogin()">Testar Login</button>
        <button onclick="fixAndTest()">Corrigir e Testar</button>
    </div>
    
    <div class="step">
        <h3>Resultados</h3>
        <div id="results">Aguardando a√ß√µes...</div>
    </div>
    
    <script>
        let diagnosisResults = [];
        
        function addDiagnosis(message, type = 'info') {
            diagnosisResults.push({ message, type });
            updateDiagnosisDisplay();
        }
        
        function updateDiagnosisDisplay() {
            const diagnosisDiv = document.getElementById('diagnosis');
            diagnosisDiv.innerHTML = diagnosisResults.map(result => 
                `<div class="${result.type}">${result.message}</div>`
            ).join('');
        }
        
        function updateResults(message, type = 'info') {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = `<div class="${type}">${message}</div>`;
        }
        
        // Diagn√≥stico autom√°tico
        function runDiagnosis() {
            addDiagnosis('üîç Iniciando diagn√≥stico...');
            
            // Verificar localStorage
            const authStorage = localStorage.getItem('auth-storage');
            if (authStorage === '[object Object]') {
                addDiagnosis('‚ùå PROBLEMA: localStorage corrompido detectado!', 'error');
            } else if (authStorage) {
                try {
                    const parsed = JSON.parse(authStorage);
                    addDiagnosis('‚úÖ localStorage v√°lido encontrado', 'success');
                } catch (e) {
                    addDiagnosis('‚ùå PROBLEMA: localStorage com JSON inv√°lido', 'error');
                }
            } else {
                addDiagnosis('‚ÑπÔ∏è Nenhum localStorage encontrado', 'info');
            }
            
            // Verificar token
            const token = localStorage.getItem('hg_token');
            if (token) {
                addDiagnosis('‚úÖ Token encontrado no localStorage', 'success');
            } else {
                addDiagnosis('‚ÑπÔ∏è Nenhum token encontrado', 'info');
            }
            
            // Verificar conectividade com backend
            fetch('http://localhost:5000/api/health')
                .then(response => {
                    if (response.ok) {
                        addDiagnosis('‚úÖ Backend acess√≠vel', 'success');
                    } else {
                        addDiagnosis('‚ùå Backend retornou erro: ' + response.status, 'error');
                    }
                })
                .catch(error => {
                    addDiagnosis('‚ùå Erro de conectividade com backend: ' + error.message, 'error');
                });
        }
        
        function clearStorage() {
            try {
                localStorage.removeItem('auth-storage');
                localStorage.removeItem('hg_token');
                sessionStorage.clear();
                updateResults('‚úÖ localStorage limpo com sucesso!', 'success');
                addDiagnosis('üßπ localStorage limpo', 'success');
            } catch (error) {
                updateResults('‚ùå Erro ao limpar localStorage: ' + error.message, 'error');
            }
        }
        
        async function testLogin() {
            updateResults('üîÑ Testando login...');
            
            try {
                const response = await fetch('http://localhost:5000/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Origin': 'http://localhost:3000'
                    },
                    credentials: 'include',
                    body: JSON.stringify({
                        email: 'admin@healthguardian.com',
                        password: 'admin123'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    updateResults(`‚úÖ Login bem-sucedido!<br>
                        <strong>Token:</strong> ${data.token.substring(0, 30)}...<br>
                        <strong>Usu√°rio:</strong> ${data.user.name}<br>
                        <strong>Email:</strong> ${data.user.email}`, 'success');
                    
                    // Salvar token para teste
                    localStorage.setItem('hg_token', data.token);
                    addDiagnosis('‚úÖ Login testado com sucesso', 'success');
                } else {
                    const errorText = await response.text();
                    updateResults(`‚ùå Erro no login (${response.status}): ${errorText}`, 'error');
                }
            } catch (error) {
                updateResults(`‚ùå Erro na requisi√ß√£o: ${error.message}`, 'error');
            }
        }
        
        async function fixAndTest() {
            updateResults('üîß Executando corre√ß√£o completa...');
            
            // Passo 1: Limpar storage
            clearStorage();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            // Passo 2: Testar login
            await testLogin();
            
            updateResults(document.getElementById('results').innerHTML + '<br><br>üéâ Corre√ß√£o completa! Agora teste no frontend React.', 'success');
        }
        
        // Executar diagn√≥stico ao carregar
        window.addEventListener('load', () => {
            setTimeout(runDiagnosis, 500);
        });
    </script>
</body>
</html>