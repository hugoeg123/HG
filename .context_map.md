# Mapa de Contexto e Codependências do Health Guardian

Este documento serve como um cache de memória para intervenções no código, mapeando dependências críticas, fluxos de dados e pontos de atenção.

## 1. Fluxo de Autenticação e Autorização
*   **Entrada**: `middleware/auth.middleware.js`
*   **Validação**: Verifica JWT no header `Authorization`.
*   **Dependência**: `req.user` é injetado nas rotas protegidas.
*   **Risco**: Alterações no middleware afetam *todas* as rotas protegidas (`/api/records`, `/api/patients`, etc.).
*   **Conexão Frontend**: Frontend deve enviar token via `axios` interceptor (verificar `frontend/src/services/api.js`).

## 2. Gestão de Registros Médicos (Records)
*   **Fluxo de Criação**:
    1.  Frontend: `HybridEditor.jsx` envia dados estruturados.
    2.  Backend: `record.controller.js` -> `createRecord`.
    3.  Parsing: `shared/parser.js` (ou `utils/vitalSignParser.js`) processa conteúdo.
    4.  Sinais Vitais: Extração automática gera entradas na tabela `PatientVitalSigns`.
    5.  Alertas: `calculateAlerts` (em `utils/vitalSignParser.js`) verifica limites e gera alertas.
*   **Codependências**:
    *   `Record` model <-> `Patient` model (ForeignKey).
    *   `Record` <-> `Tag` (Many-to-Many).
    *   `Record` <-> `Medico` (ForeignKey `medicoCriador`).

## 3. Integração de IA
*   **Componentes**: `ai.controller.js` <-> `ai.service.js`.
*   **Contexto**: O sistema mantém um contexto por usuário (`getContext`, `addContext`).
*   **Endpoints**:
    *   `POST /api/ai/chat`: Interação principal.
    *   `GET /api/ai/context`: Recuperação de estado.
*   **Atenção**: O frontend pode estar esperando endpoints legados (`/suggestions`) que não existem no controller atual. Verificar alinhamento.

## 4. Agenda e Slots
*   **Estrutura**: `AvailabilitySlot` (disponibilidade) e `Appointment` (agendamento).
*   **Lógica**:
    *   Criação de slots via drag-and-drop no frontend.
    *   Validação de conflitos no backend (`agenda.controller.js`).
*   **Dependência**: `Medico` model.

## 5. Frontend - Estrutura de Componentes
*   **Estado Global**: Zustand (provavelmente em `src/store`).
*   **Editor**: `PatientView/HybridEditor.jsx` é crítico para a entrada de dados.
*   **Rotas**: React Router.

## 6. Pontos de Atenção para Manutenção (Tech Debt)
*   **Testes**: Ausência de suíte de testes automatizados (Crítico).
*   **FHIR**: Exportação FHIR mencionada na visão geral, mas implementação não localizada explicitamente nos controllers principais.
*   **Validação**: Dependência forte de `express-validator` nos controllers.

## 7. Próximos Passos Sugeridos
*   Implementar testes unitários para `vitalSignParser.js` (lógica crítica de saúde).
*   Padronizar endpoints de IA.
*   Criar adapter para exportação FHIR.
