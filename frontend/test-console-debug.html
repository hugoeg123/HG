<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Console Debug - Health Guardian</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .success { background-color: #d4edda; border-color: #c3e6cb; }
        .error { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        pre {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            white-space: pre-wrap;
        }
        .log {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #007bff;
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîç Console Debug - Health Guardian</h1>
        
        <div class="section info">
            <h3>üìã Informa√ß√µes do Sistema</h3>
            <div id="system-info"></div>
        </div>

        <div class="section">
            <h3>üß™ Testes de Conectividade</h3>
            <button onclick="testBackend()">Testar Backend</button>
            <button onclick="testAuth()">Testar Autentica√ß√£o</button>
            <button onclick="testRecordsAPI()">Testar API de Registros</button>
            <button onclick="clearLogs()">Limpar Logs</button>
            <div id="connectivity-results"></div>
        </div>

        <div class="section">
            <h3>üìù Busca de Registros de Pacientes</h3>
            <input type="text" id="patient-id" placeholder="ID do Paciente" value="0a3565f7-14e6-44e7-9385-5974e117065d">
            <button onclick="fetchPatientRecords()">Buscar Registros</button>
            <div id="records-results"></div>
        </div>

        <div class="section">
            <h3>üìä Logs de Depura√ß√£o</h3>
            <div id="debug-logs"></div>
        </div>
    </div>

    <script>
        // Token JWT de teste
        const TEST_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOiJjYjU5MDMzMC1kOTVhLTQzZmUtYjNiOS0zMGIwNjlhOGE3NTMiLCJlbWFpbCI6ImRyLnNpbHZhQGV4YW1wbGUuY29tIiwiaWF0IjoxNzU0NjEwNzQ5LCJleHAiOjE3NTQ2OTcxNDl9.Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8Ej8';
        
        function log(message, type = 'info') {
            console.log(`[${type.toUpperCase()}] ${message}`);
            const logsDiv = document.getElementById('debug-logs');
            const logElement = document.createElement('div');
            logElement.className = 'log';
            logElement.innerHTML = `<strong>[${new Date().toLocaleTimeString()}]</strong> ${message}`;
            logsDiv.appendChild(logElement);
            logsDiv.scrollTop = logsDiv.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('debug-logs').innerHTML = '';
            document.getElementById('connectivity-results').innerHTML = '';
            document.getElementById('records-results').innerHTML = '';
        }

        function displaySystemInfo() {
            const info = {
                'User Agent': navigator.userAgent,
                'URL Atual': window.location.href,
                'Local Storage Token': localStorage.getItem('hg_token') ? 'Presente' : 'Ausente',
                'Timestamp': new Date().toISOString()
            };
            
            let html = '<pre>';
            for (const [key, value] of Object.entries(info)) {
                html += `${key}: ${value}\n`;
            }
            html += '</pre>';
            
            document.getElementById('system-info').innerHTML = html;
            log('Informa√ß√µes do sistema carregadas');
        }

        async function testBackend() {
            log('üîÑ Testando conectividade com backend...');
            try {
                const response = await fetch('http://localhost:3001/api/health');
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Backend conectado com sucesso', 'success');
                    document.getElementById('connectivity-results').innerHTML += 
                        '<div class="section success">‚úÖ Backend: Conectado</div>';
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erro ao conectar com backend: ${error.message}`, 'error');
                document.getElementById('connectivity-results').innerHTML += 
                    `<div class="section error">‚ùå Backend: Erro - ${error.message}</div>`;
            }
        }

        async function testAuth() {
            log('üîÑ Testando autentica√ß√£o...');
            try {
                const response = await fetch('http://localhost:3001/auth/verify', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('‚úÖ Token v√°lido', 'success');
                    document.getElementById('connectivity-results').innerHTML += 
                        '<div class="section success">‚úÖ Autentica√ß√£o: Token v√°lido</div>';
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erro na autentica√ß√£o: ${error.message}`, 'error');
                document.getElementById('connectivity-results').innerHTML += 
                    `<div class="section error">‚ùå Autentica√ß√£o: Erro - ${error.message}</div>`;
            }
        }

        async function testRecordsAPI() {
            log('üîÑ Testando API de registros...');
            try {
                const response = await fetch('http://localhost:3001/api/records', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ API de registros funcionando. Total: ${data.length} registros`, 'success');
                    document.getElementById('connectivity-results').innerHTML += 
                        `<div class="section success">‚úÖ API Registros: ${data.length} registros encontrados</div>`;
                } else {
                    throw new Error(`Status: ${response.status}`);
                }
            } catch (error) {
                log(`‚ùå Erro na API de registros: ${error.message}`, 'error');
                document.getElementById('connectivity-results').innerHTML += 
                    `<div class="section error">‚ùå API Registros: Erro - ${error.message}</div>`;
            }
        }

        async function fetchPatientRecords() {
            const patientId = document.getElementById('patient-id').value;
            if (!patientId) {
                log('‚ùå ID do paciente √© obrigat√≥rio', 'error');
                return;
            }

            log(`üîÑ Buscando registros para paciente: ${patientId}`);
            try {
                const response = await fetch(`http://localhost:3001/api/records/patient/${patientId}`, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${TEST_TOKEN}`,
                        'Content-Type': 'application/json'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log(`‚úÖ Registros encontrados: ${data.length}`, 'success');
                    
                    let html = `<div class="section success">`;
                    html += `<h4>‚úÖ Registros do Paciente (${data.length} encontrados)</h4>`;
                    html += '<pre>' + JSON.stringify(data, null, 2) + '</pre>';
                    html += '</div>';
                    
                    document.getElementById('records-results').innerHTML = html;
                } else {
                    const errorText = await response.text();
                    throw new Error(`Status: ${response.status}, Response: ${errorText}`);
                }
            } catch (error) {
                log(`‚ùå Erro ao buscar registros: ${error.message}`, 'error');
                document.getElementById('records-results').innerHTML = 
                    `<div class="section error">‚ùå Erro: ${error.message}</div>`;
            }
        }

        // Interceptar console.log para capturar logs do sistema
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            if (args[0] && typeof args[0] === 'string') {
                if (args[0].includes('PatientView') || args[0].includes('fetchPatientRecords') || args[0].includes('recordService')) {
                    log(`üîç Sistema: ${args.join(' ')}`, 'info');
                }
            }
        };

        // Interceptar console.error para capturar erros
        const originalError = console.error;
        console.error = function(...args) {
            originalError.apply(console, args);
            log(`‚ùå Erro do Sistema: ${args.join(' ')}`, 'error');
        };

        // Inicializar p√°gina
        window.addEventListener('load', () => {
            displaySystemInfo();
            log('üöÄ P√°gina de debug carregada');
        });
    </script>
</body>
</html>